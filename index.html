<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deal or No Deal ‚Äî ‚Çπ Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --muted:#96a0b3; --ink:#e9f0ff; --accent:#7cc7ff; --accent-2:#00e0b8; --warn:#ff857a; --gold:#ffd166;
      --card:#0f141c; --card2:#0c1118; --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:radial-gradient(1200px 800px at 20% -10%, #162033 0%, #0b0f14 60%);}    
    a{color:var(--accent)}
    .app{max-width:1200px; margin:0 auto; padding:24px;}
    header{display:flex; align-items:center; gap:16px; margin-bottom:20px}
    .logo{font-weight:800; font-size:clamp(20px,3vw,28px); letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px}
    .wrap{display:grid; grid-template-columns: 1.5fr .9fr; gap:24px}
    @media (max-width: 980px){ .wrap{grid-template-columns: 1fr;}}

    .panel{background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%); border:1px solid #1e2837; border-radius:16px; box-shadow:var(--shadow)}
    .panel h2{margin:0; padding:18px 20px; border-bottom:1px solid #1e2837; font-size:16px; letter-spacing:.25px}

    .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; border-bottom:1px solid #1e2837;}
    .hint{color:var(--muted); font-size:14px}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; color:#041018; background:linear-gradient(180deg, var(--accent), #5db8ff); cursor:pointer; box-shadow: 0 6px 18px rgba(124,199,255,.35)}
    .btn.secondary{background: #192332; color: var(--ink); border:1px solid #273246; box-shadow:none}
    .btn.warn{background: linear-gradient(180deg, #ff9a91, #ff6b5f); color:#2b0b0b}

    .grid{display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; padding:16px}
    @media (max-width: 600px){ .grid{grid-template-columns: repeat(4, 1fr);} }
    .box{position:relative; aspect-ratio: 1.2/1; display:flex; align-items:center; justify-content:center; border-radius:14px; user-select:none; cursor:pointer; font-weight:800; letter-spacing:.3px; font-size:18px; transition:.18s transform ease, .18s opacity ease, .18s filter ease;}
    .box::before{content:""; position:absolute; inset:0; border-radius:14px; background:linear-gradient(180deg, #0f1828, #0c1220); border:1px solid #1e2a41; box-shadow: inset 0 0 0 1px rgba(255,255,255,.03), 0 8px 16px rgba(0,0,0,.35)}
    .box span{position:relative; z-index:1}
    .box:hover{transform: translateY(-2px)}
    .box.opened{filter:saturate(.35) brightness(.75); cursor:default}
    .box.revealed::after{content:attr(data-value); position:absolute; inset:auto 6px 6px auto; background:rgba(0,0,0,.55); padding:6px 10px; border-radius:8px; font-size:12px; color:var(--gold); border:1px solid rgba(255,209,102,.45)}

    /* Held box slot */
    .held-slot{padding:0 16px 16px}
    .held-card{display:flex; align-items:center; gap:12px; padding:12px 14px; border-radius:14px; border:1px dashed #1e6d62; background:linear-gradient(180deg, rgba(0,224,184,.08), rgba(124,199,255,.06)); box-shadow: inset 0 0 0 2px rgba(0,224,184,.25)}
    .held-card .badge{width:42px; height:42px; display:flex; align-items:center; justify-content:center; border-radius:10px; font-weight:800; background:linear-gradient(180deg, #0f1828, #0c1220); border:1px solid #1e2a41}
    .held-card .meta{font-size:13px; color:var(--muted)}

    .side{display:grid; grid-template-rows:auto auto 1fr auto; gap:12px; padding:12px}
    .stats{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .stat{background:#121a29; border:1px solid #1e2837; border-radius:12px; padding:12px; text-align:center}
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:800}

    .values{display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:12px}
    .pill{background:#101828; border:1px solid #1e2837; border-radius:10px; padding:8px 10px; font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center}
    .pill.live{color:#d8e7ff}
    .pill.gone{opacity:.45; text-decoration:line-through}

    .footer{display:flex; gap:8px; justify-content:space-between; align-items:center; padding:10px 12px; border-top:1px solid #1e2837}
    .note{color:var(--muted); font-size:12px}

    .modal-backdrop{position:fixed; inset:0; background:rgba(5,8,12,.6); display:none; align-items:center; justify-content:center; z-index:50}
    .modal{width:min(580px, 92vw); background:linear-gradient(180deg, #0f141c, #0c1118); border:1px solid #1e2837; border-radius:16px; box-shadow: var(--shadow); overflow:hidden}
    .modal header{padding:16px 18px; border-bottom:1px solid #1e2837; justify-content:space-between}
    .modal .body{padding:18px}
    .deal-actions{display:flex; gap:10px; justify-content:flex-end; padding:12px 18px; border-top:1px solid #1e2837}

    .tada{animation: tada .6s ease}
    @keyframes tada{0%{transform:scale(1)} 20%{transform:scale(1.04)} 40%{transform:scale(.98)} 60%{transform:scale(1.02)} 80%{transform:scale(.99)} 100%{transform:scale(1)}}

    .riskbar{height:12px; background:#0d1522; border:1px solid #1e2837; border-radius:999px; overflow:hidden}
    .riskbar > div{height:100%; background:linear-gradient(90deg, #7cc7ff, #00e0b8); width:0%}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">DEAL or NO DEAL ‚Äî <span style="color:var(--accent)">‚Çπ</span> Edition</div>
      <div class="sub">Pick one personal box. Open others, take offers‚Ä¶ or hold to the end.</div>
      <div style="flex:1"></div>
      <button id="newGameBtn" class="btn secondary">New Game</button>
    </header>

    <div class="wrap">
      <section class="panel">
        <div class="toolbar">
          <div class="hint" id="hint">Choose your personal box (click one). It stays sealed till the end.</div>
          <div>
            <button id="undoBtn" class="btn secondary" title="Undo last open" disabled>Undo</button>
          </div>
        </div>
        <div class="grid" id="grid"></div>
        <div class="held-slot">
          <div id="heldSlot" class="held-card" style="display:none">
            <div class="badge" id="heldBadge">‚Äî</div>
            <div>
              <div style="font-weight:800">Your Held Box</div>
              <div class="meta">Stays sealed until you Deal or reach the end.</div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="note" id="roundInfo">Round 0</div>
          <div class="note" id="heldInfo">Held: ‚Äî</div>
        </div>
      </section>

      <aside class="panel side">
        <h2>Game Stats</h2>
        <div class="stats">
          <div class="stat"><div class="k">Attempts</div><div class="v" id="attempts">0</div></div>
          <div class="stat"><div class="k">Boxes Left</div><div class="v" id="boxesLeft">26</div></div>
        </div>
        <div class="panel" style="margin:6px 0">
          <h2>Remaining Values</h2>
          <div class="values" id="valuesList"></div>
        </div>
        <div class="panel">
          <h2>Banker</h2>
          <div class="toolbar">
            <div class="hint">Offer updates after every opened box.</div>
            <button id="showOfferBtn" class="btn secondary" disabled>Show Offer</button>
          </div>
          <div style="padding:12px 16px; color:var(--muted); font-size:14px" id="offerPreview">‚Äî</div>
        </div>
        <div class="footer">
          <div class="note">Tip: Early offers are conservative; they grow as the game progresses.</div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal for Offer -->
  <div class="modal-backdrop" id="offerModal">
    <div class="modal tada">
      <header>
        <div style="font-weight:800">Banker‚Äôs Offer</div>
        <button class="btn secondary" id="closeModal" aria-label="Close">Close</button>
      </header>
      <div class="body">
        <div id="offerContext" style="font-size:14px; color:var(--muted); margin-bottom:10px">‚Äî</div>
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px">
          <div style="font-size:clamp(26px, 4vw, 34px); font-weight:800; letter-spacing:.3px" id="offerAmount">‚Çπ0</div>
        </div>
        <div style="display:grid; gap:8px">
          <div style="display:flex; align-items:center; justify-content:space-between; font-size:12px; color:var(--muted)">
            <div>Risk meter</div>
            <div id="riskLabel">0%</div>
          </div>
          <div class="riskbar"><div id="riskFill"></div></div>
        </div>
      </div>
      <div class="deal-actions">
        <button id="noDealBtn" class="btn secondary">No Deal</button>
        <button id="dealBtn" class="btn">Deal</button>
      </div>
    </div>
  </div>

  <!-- Modal for Final Result -->
  <div class="modal-backdrop" id="finalModal">
    <div class="modal tada">
      <header>
        <div style="font-weight:800">Result</div>
        <button class="btn secondary" id="closeFinal" aria-label="Close">Close</button>
      </header>
      <div class="body" id="finalBody" style="font-size:16px"></div>
      <div class="deal-actions">
        <button class="btn" id="playAgainBtn">Play Again</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const fmt = (n)=> n.toLocaleString('en-IN', {maximumFractionDigits:0, style:'currency', currency:'INR'}).replace('‚Çπ\\u00A0','‚Çπ');

    const BOX_VALUES = [
      1, 5, 10, 25, 50,
      100, 200, 500,
      1000, 2000, 5000,
      10000, 25000, 50000, 75000,
      100000, 200000, 300000, 500000, 750000,
      1000000, 1500000, 2000000, 2500000, 3500000, 5000000
    ];

    // Banker formula: EV * risk * damping - variance penalty (early only)
    function bankerOffer(remainingValues, attemptsDone, totalAttempts){
      const exp = remainingValues.reduce((a,b)=>a+b,0) / remainingValues.length;
      const progress = attemptsDone / Math.max(1, totalAttempts);
      const risk = 0.50 + 0.40 * progress; // 0.50 -> 0.90

      let damping = 1.0;
      if (attemptsDone <= 1) damping = 0.40;
      else if (attemptsDone === 2) damping = 0.50;
      else if (attemptsDone === 3) damping = 0.60;
      else if (attemptsDone === 4) damping = 0.70;

      let offer = exp * risk;
      if (remainingValues.length > 3){
        const mean = exp;
        const variance = remainingValues.reduce((s,x)=> s + (x-mean)*(x-mean), 0) / remainingValues.length;
        const std = Math.sqrt(variance);
        offer -= 0.04 * std;
      }
      offer *= damping;

      return { amount: Math.max(0, Math.round(offer)), risk, damping, exp };
    }

    // ===== State =====
    let boxes = []; // {label, value, opened, held}
    let heldLabel = null;
    let attempts = 0;
    let history = []; // stack for undo: {label}
    let lastOpenedValue = null; // for offer context

    const el = (id)=>document.getElementById(id);

    function initGame(){
      const labels = Array.from({length:26}, (_,i)=> i+1);
      const values = [...BOX_VALUES];
      // Shuffle values
      for(let i=values.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [values[i], values[j]] = [values[j], values[i]];
      }
      boxes = labels.map((lab, i)=> ({label: lab, value: values[i], opened:false, held:false}));
      heldLabel = null; attempts = 0; history = []; lastOpenedValue = null;
      renderAll();
      setHint('Choose your personal box (click one). It stays sealed till the end.');
      el('undoBtn').disabled = true;
      el('showOfferBtn').disabled = true;
      el('offerPreview').textContent = '‚Äî';
      el('roundInfo').textContent = 'Round 0';
      el('heldInfo').textContent = 'Held: ‚Äî';
    }

    function setHint(msg){ el('hint').textContent = msg; }

    function renderAll(){
      renderGrid();
      renderHeld();
      renderStats();
      renderValuesList();
      updateOfferPreview();
    }

    function renderGrid(){
      const g = el('grid');
      g.innerHTML = '';
      const sorted = [...boxes].sort((a,b)=> a.label - b.label);
      for(const b of sorted){
        if (b.held) continue; // don't show held box in grid
        const div = document.createElement('div');
        div.className = 'box' + (b.opened?' opened revealed':'');
        div.dataset.label = b.label;
        if (b.opened){ div.dataset.value = fmt(b.value); }
        const sp = document.createElement('span');
        sp.textContent = b.label;
        div.appendChild(sp);
        div.addEventListener('click', ()=> onBoxClick(b.label));
        g.appendChild(div);
      }
    }

    function renderHeld(){
      const slot = el('heldSlot');
      if (!heldLabel){ slot.style.display = 'none'; return; }
      const held = boxes.find(b=> b.label === heldLabel);
      el('heldBadge').textContent = held.label;
      slot.style.display = 'flex';
      el('heldInfo').textContent = `Held: ${heldLabel}`;
    }

    function renderStats(){
      el('attempts').textContent = attempts;
      const unopened = boxes.filter(b=> !b.opened).length; // includes held
      el('boxesLeft').textContent = unopened;
      const roundText = `Round ${attempts}`;
      el('roundInfo').textContent = roundText;
    }

    function renderValuesList(){
      const container = el('valuesList');
      container.innerHTML = '';
      const all = BOX_VALUES.slice().sort((a,b)=> a-b); // ascending
      const unopenedVals = new Set(boxes.filter(b=> !b.opened).map(b=> b.value));
      const left = all.slice(0, 13);
      const right = all.slice(13);
      function makeCol(arr){
        const col = document.createElement('div');
        col.style.display = 'grid';
        col.style.gap = '8px';
        for(const v of arr){
          const d = document.createElement('div');
          const isLive = unopenedVals.has(v);
          d.className = 'pill ' + (isLive? 'live':'gone');
          d.innerHTML = `<div>${fmt(v)}</div><div>${isLive? '‚óè':'√ó'}</div>`;
          col.appendChild(d);
        }
        return col;
      }
      container.appendChild(makeCol(left));
      container.appendChild(makeCol(right));
    }

    function currentOffer(){
      const remaining = boxes.filter(b=> !b.opened).map(b=> b.value); // unopened incl. held
      return bankerOffer(remaining, attempts, 25);
    }

    function updateOfferPreview(){
      if (attempts === 0){ el('offerPreview').textContent = '‚Äî'; return; }
      const {amount} = currentOffer();
      el('offerPreview').textContent = `Current offer: ${fmt(amount)}`;
    }

    function onBoxClick(label){
      const idx = boxes.findIndex(b=> b.label === label);
      if (idx === -1) return;
      const b = boxes[idx];

      // First click: choose held
      if (!heldLabel){
        b.held = true; heldLabel = b.label; renderAll();
        setHint('Now open a DIFFERENT box to reveal it. Your box stays sealed.');
        playSound('click');
        return;
      }

      // After holding, can only open non-held, non-opened boxes
      if (b.held || b.opened) return;

      // Open this box (show its value first)
      b.opened = true;
      attempts += 1;
      history.push({label: b.label});
      lastOpenedValue = b.value;
      playSound('click');

      renderAll();
      el('undoBtn').disabled = history.length === 0;
      el('showOfferBtn').disabled = false;

      // If only held remains (i.e., all others opened), end immediately
      const unopenedCount = boxes.filter(x=> !x.opened).length; // includes held
      if (unopenedCount === 1){
        endWithHeld();
        return;
      }

      // Delay the offer so user sees the revealed value first
      setTimeout(()=>{ showOfferModal(); }, 900);
    }

    // ===== Offer Modal =====
    function showOfferModal(){
      const back = el('offerModal');
      const {amount, risk, damping, exp} = currentOffer();
      el('offerAmount').textContent = fmt(amount);
      const remainingCount = boxes.filter(b=> !b.opened).length;
      const openedTxt = lastOpenedValue != null ? `You opened ${fmt(lastOpenedValue)}.` : '';
      el('offerContext').innerHTML = `${openedTxt} Remaining unopened boxes: <strong>${remainingCount}</strong>. Expected value ‚âà <strong>${fmt(Math.round(exp))}</strong>`;
      const effective = Math.max(0, Math.min(1, risk * (damping || 1)));
      el('riskFill').style.width = Math.round(effective*100) + '%';
      el('riskLabel').textContent = Math.round(effective*100) + '%';
      back.style.display = 'flex';
      playSound('offer');
    }
    function hideOfferModal(){ el('offerModal').style.display = 'none'; }

    el('showOfferBtn').addEventListener('click', showOfferModal);
    el('closeModal').addEventListener('click', hideOfferModal);

    el('noDealBtn').addEventListener('click', ()=>{
      hideOfferModal();
      setHint('No Deal. Open another box (not your held one).');
      playSound('click');
      if (boxes.filter(b=> !b.opened).length === 1) endWithHeld();
    });

    el('dealBtn').addEventListener('click', ()=>{
      const {amount} = currentOffer();
      hideOfferModal();
      playSound('win');
      endWithDeal(amount);
    });

    function endWithDeal(amount){
      const held = boxes.find(b=> b.label === heldLabel);
      const final = el('finalBody');
      final.innerHTML = `
        <div style="margin-bottom:10px; color:var(--muted)">You took the banker‚Äôs deal.</div>
        <div style="font-size:28px; font-weight:800; margin-bottom:12px">You win: ${fmt(amount)}</div>
        <div>Your sealed box was <strong>#${held.label}</strong>.</div>
      `;
      el('finalModal').style.display = 'flex';
    }

    function endWithHeld(){
      const held = boxes.find(b=> b.label === heldLabel);
      const final = el('finalBody');
      final.innerHTML = `
        <div style="margin-bottom:10px; color:var(--muted)">No Deal to the end. Only your box remains.</div>
        <div style="font-size:28px; font-weight:800; margin-bottom:12px">Your box #${held.label} contains: ${fmt(held.value)}</div>
        <div>You win: <strong>${fmt(held.value)}</strong> üéâ</div>
      `;
      el('finalModal').style.display = 'flex';
      playSound('win');
    }

    el('closeFinal').addEventListener('click', ()=> el('finalModal').style.display = 'none');
    el('playAgainBtn').addEventListener('click', ()=>{ el('finalModal').style.display='none'; initGame(); });

    // ===== Undo (reverts last OPEN) =====
    el('undoBtn').addEventListener('click', ()=>{
      if (!history.length || attempts === 0) return;
      const last = history.pop();
      const b = boxes.find(x=> x.label === last.label);
      if (b){ b.opened = false; }
      attempts -= 1;
      lastOpenedValue = null;
      renderAll();
      el('undoBtn').disabled = history.length === 0;
      playSound('click');
    });

    // ===== New Game =====
    el('newGameBtn').addEventListener('click', initGame);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') { hideOfferModal(); el('finalModal').style.display='none'; }
    });

    // Boot
    initGame();

    // ===== Sounds (WebAudio) =====
    let audioCtx;
    function beep(freq=440, dur=0.08, gain=0.02){
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + dur);
    }
    function playSound(kind){
      if (kind==='click') { beep(520, 0.05, 0.03); }
      else if (kind==='offer') { beep(440, 0.06, 0.025); setTimeout(()=>beep(660, 0.06, 0.02), 80); }
      else if (kind==='win') { beep(660, 0.07, 0.03); setTimeout(()=>beep(880, 0.09, 0.03), 90); setTimeout(()=>beep(990, 0.12, 0.02), 200); }
    }
  </script>
</body>
</html>
